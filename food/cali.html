<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8">
<title>Meal Planner Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Meal Planner">
<meta name="theme-color" content="#0d0d1a">
<link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'&gt;&lt;text y='0.9em' font-size='90'&gt;üçΩÔ∏è&lt;/text&gt;&lt;/svg&gt;">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,&lt;svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'&gt;&lt;text y='0.9em' font-size='90'&gt;üçΩÔ∏è&lt;/text&gt;&lt;/svg&gt;">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">

<!-- Google Analytics - Replace YOUR_GA_MEASUREMENT_ID with your actual Google Analytics ID -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=YOUR_GA_MEASUREMENT_ID"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'YOUR_GA_MEASUREMENT_ID');

// Custom event tracking helper
function trackEvent(category, action, label) {
  if (typeof gtag !== 'undefined') {
    gtag('event', action, {
      'event_category': category,
      'event_label': label
    });
  }
}
</script>

<style>
:root{
--bg-primary:#0a0a14;
--bg-secondary:#12121f;
--bg-tertiary:#1a1a2e;
--card-bg:rgba(255,255,255,.06);
--card-bg-hover:rgba(255,255,255,.1);
--card-border:rgba(255,255,255,.08);
--text-primary:#f5f5f7;
--text-secondary:#a1a1aa;
--text-muted:#71717a;
--accent-primary:#3b82f6;
--accent-secondary:#8b5cf6;
--accent-gradient:linear-gradient(135deg,#3b82f6,#8b5cf6);
--success:#10b981;
--warning:#f59e0b;
--danger:#ef4444;
--sidebar-bg:rgba(10,10,20,.95);
--spacing-xs:.25rem;
--spacing-sm:.5rem;
--spacing-md:1rem;
--spacing-lg:1.5rem;
--spacing-xl:2rem;
--radius-sm:.375rem;
--radius-md:.5rem;
--radius-lg:.75rem;
--radius-xl:1rem;
--shadow-sm:0 1px 2px 0 rgba(0,0,0,.3);
--shadow-md:0 4px 6px -1px rgba(0,0,0,.4);
--shadow-lg:0 10px 15px -3px rgba(0,0,0,.5);
--shadow-xl:0 20px 25px -5px rgba(0,0,0,.6);
--safe-area-inset-top:env(safe-area-inset-top);
--safe-area-inset-bottom:env(safe-area-inset-bottom);
--safe-area-inset-left:env(safe-area-inset-left);
--safe-area-inset-right:env(safe-area-inset-right);
}

*{
-webkit-tap-highlight-color:transparent;
-webkit-touch-callout:none;
}

body{
font-family:'Inter',system-ui,-apple-system,sans-serif;
background:linear-gradient(135deg,var(--bg-primary),var(--bg-secondary),var(--bg-tertiary));
background-attachment:fixed;
color:var(--text-primary);
min-height:100vh;
margin:0;
padding:0;
overscroll-behavior-y:none;
-webkit-font-smoothing:antialiased;
}

.app-container{
min-height:100vh;
padding-top:calc(var(--safe-area-inset-top) + var(--spacing-md));
padding-bottom:calc(var(--safe-area-inset-bottom) + 80px);
padding-left:max(var(--safe-area-inset-left),var(--spacing-md));
padding-right:max(var(--safe-area-inset-right),var(--spacing-md));
}

.app-header{
text-align:center;
margin-bottom:var(--spacing-xl);
position:relative;
}

.app-title{
font-size:clamp(1.75rem,5vw,2.5rem);
font-weight:700;
background:var(--accent-gradient);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
background-clip:text;
margin:0 0 var(--spacing-sm);
letter-spacing:-.02em;
}

.app-subtitle{
font-size:.95rem;
color:var(--text-secondary);
font-weight:400;
}

.toolbar{
display:flex;
gap:var(--spacing-sm);
margin-bottom:var(--spacing-lg);
flex-wrap:wrap;
position:sticky;
top:calc(var(--safe-area-inset-top) + var(--spacing-sm));
background:rgba(10,10,20,.85);
backdrop-filter:blur(20px) saturate(180%);
-webkit-backdrop-filter:blur(20px) saturate(180%);
padding:var(--spacing-md);
border-radius:var(--radius-lg);
box-shadow:var(--shadow-lg);
z-index:100;
border:1px solid var(--card-border);
}

.btn-custom{
flex:1;
min-width:110px;
padding:.65rem .9rem;
border-radius:var(--radius-md);
border:1px solid var(--card-border);
background:var(--card-bg);
color:var(--text-primary);
font-size:.875rem;
font-weight:500;
transition:all .2s cubic-bezier(.4,0,.2,1);
display:flex;
align-items:center;
justify-content:center;
gap:var(--spacing-xs);
cursor:pointer;
white-space:nowrap;
}

.btn-custom:hover{
background:var(--card-bg-hover);
transform:translateY(-1px);
box-shadow:var(--shadow-md);
border-color:var(--accent-primary);
}

.btn-custom:active{
transform:translateY(0);
}

.btn-custom i{
font-size:1.1rem;
}

.btn-primary-custom{
background:var(--accent-gradient);
border:none;
color:#fff;
font-weight:600;
}

.btn-primary-custom:hover{
filter:brightness(1.1);
box-shadow:0 0 20px rgba(59,130,246,.4);
}

.btn-success-custom{
background:var(--success);
border:none;
color:#fff;
}

.btn-success-custom:hover{
filter:brightness(1.1);
}

.main-wrapper{
display:grid;
grid-template-columns:280px 1fr;
gap:var(--spacing-lg);
max-width:1800px;
margin:0 auto;
}

.sidebar{
background:var(--sidebar-bg);
backdrop-filter:blur(20px) saturate(180%);
-webkit-backdrop-filter:blur(20px) saturate(180%);
border-radius:var(--radius-xl);
padding:var(--spacing-lg);
border:1px solid var(--card-border);
box-shadow:var(--shadow-lg);
position:sticky;
top:calc(var(--safe-area-inset-top) + 120px);
height:fit-content;
max-height:calc(100vh - 200px);
overflow-y:auto;
-webkit-overflow-scrolling:touch;
}

.sidebar::-webkit-scrollbar{
width:6px;
}

.sidebar::-webkit-scrollbar-track{
background:transparent;
}

.sidebar::-webkit-scrollbar-thumb{
background:var(--card-border);
border-radius:3px;
}

.sidebar-header{
font-size:1.1rem;
font-weight:600;
color:var(--text-primary);
margin:0 0 var(--spacing-md);
display:flex;
align-items:center;
gap:var(--spacing-sm);
}

.search-box{
width:100%;
padding:.75rem 1rem;
padding-left:2.75rem;
background:var(--card-bg);
border:1px solid var(--card-border);
border-radius:var(--radius-md);
color:var(--text-primary);
font-size:.9rem;
transition:all .2s;
}

.search-wrapper{
position:relative;
margin-bottom:var(--spacing-md);
}

.search-wrapper i{
position:absolute;
left:1rem;
top:50%;
transform:translateY(-50%);
color:var(--text-muted);
pointer-events:none;
z-index:1;
}

.search-box:focus{
outline:none;
border-color:var(--accent-primary);
box-shadow:0 0 0 3px rgba(59,130,246,.1);
background:var(--card-bg-hover);
}

.recipe-items{
display:flex;
flex-direction:column;
gap:var(--spacing-sm);
}

.recipe-item{
background:var(--card-bg);
border:1px solid var(--card-border);
border-radius:var(--radius-md);
padding:.875rem 1rem;
cursor:pointer;
user-select:none;
font-size:.9rem;
color:var(--text-primary);
font-weight:500;
transition:all .2s cubic-bezier(.4,0,.2,1);
touch-action:manipulation;
display:flex;
align-items:center;
justify-content:space-between;
gap:var(--spacing-sm);
position:relative;
overflow:hidden;
}

.recipe-item-content{
display:flex;
align-items:center;
gap:var(--spacing-sm);
flex:1;
pointer-events:none;
}

.recipe-item-actions{
display:flex;
gap:var(--spacing-xs);
}

.recipe-item::before{
content:'';
position:absolute;
left:0;
top:0;
height:100%;
width:3px;
background:var(--accent-gradient);
transform:scaleY(0);
transition:transform .2s;
}

.recipe-item:hover{
background:var(--card-bg-hover);
transform:translateX(4px);
border-color:var(--accent-primary);
box-shadow:var(--shadow-md);
}

.recipe-item:hover::before{
transform:scaleY(1);
}

.recipe-item:active{
transform:scale(.98);
}

.recipe-item.dragging{
opacity:.5;
}

.recipe-item.selected-for-assign{
background:var(--accent-gradient);
border-color:transparent;
transform:scale(1.02);
}

.recipe-item.selected-for-assign .recipe-item-content{
color:#fff;
}

.recipe-icon{
font-size:1.2rem;
flex-shrink:0;
}

/* NEW: Recipe thumbnail styles */
.recipe-thumbnail{
width:40px;
height:40px;
border-radius:var(--radius-sm);
object-fit:cover;
flex-shrink:0;
border:1px solid var(--card-border);
}

.recipe-thumbnail-large{
width:100%;
max-width:400px;
height:auto;
max-height:300px;
object-fit:cover;
border-radius:var(--radius-lg);
margin-bottom:var(--spacing-lg);
border:1px solid var(--card-border);
}

.icon-btn{
width:32px;
height:32px;
display:flex;
align-items:center;
justify-content:center;
background:rgba(255,255,255,.1);
border:1px solid var(--card-border);
border-radius:var(--radius-sm);
cursor:pointer;
font-size:.9rem;
transition:all .2s;
z-index:2;
}

.icon-btn:hover{
background:var(--accent-primary);
border-color:var(--accent-primary);
transform:scale(1.1);
}

.icon-btn:active{
transform:scale(.95);
}

.weekday-header{
display:grid;
grid-template-columns:repeat(7,1fr);
gap:var(--spacing-md);
margin-bottom:var(--spacing-md);
}

.weekday-label{
text-align:center;
font-size:.85rem;
font-weight:600;
color:var(--text-secondary);
text-transform:uppercase;
letter-spacing:.05em;
}

.calendar-wrapper{
background:var(--card-bg);
backdrop-filter:blur(20px) saturate(180%);
-webkit-backdrop-filter:blur(20px) saturate(180%);
border-radius:var(--radius-xl);
padding:var(--spacing-lg);
border:1px solid var(--card-border);
box-shadow:var(--shadow-lg);
}

.calendar{
display:grid;
grid-template-columns:repeat(7,1fr);
gap:var(--spacing-md);
}

.day-card{
background:var(--bg-secondary);
border:1px solid var(--card-border);
border-radius:var(--radius-lg);
padding:var(--spacing-md);
min-height:120px;
cursor:pointer;
transition:all .2s cubic-bezier(.4,0,.2,1);
position:relative;
display:flex;
flex-direction:column;
overflow:hidden;
}

.day-card::before{
content:'';
position:absolute;
top:0;
left:0;
right:0;
height:2px;
background:var(--accent-gradient);
transform:scaleX(0);
transition:transform .3s;
}

.day-card:hover{
background:var(--card-bg-hover);
transform:translateY(-2px);
box-shadow:var(--shadow-md);
border-color:var(--accent-primary);
}

.day-card:hover::before{
transform:scaleX(1);
}

.day-card.outside-trip{
opacity:.3;
cursor:default;
pointer-events:none;
}

.day-card.outside-trip:hover{
transform:none;
box-shadow:none;
}

.day-card.today{
border-color:var(--accent-primary);
box-shadow:0 0 0 1px var(--accent-primary),var(--shadow-md);
}

.day-card.can-assign{
animation:pulse 1.5s infinite;
border-color:var(--success);
}

@keyframes pulse{
0%, 100%{
box-shadow:0 0 0 0 rgba(16,185,129,.4);
}
50%{
box-shadow:0 0 0 8px rgba(16,185,129,0);
}
}

.day-date{
font-size:.85rem;
color:var(--text-muted);
font-weight:500;
margin-bottom:var(--spacing-sm);
}

.day-number{
font-size:1.5rem;
font-weight:700;
color:var(--text-primary);
line-height:1;
margin-bottom:var(--spacing-sm);
}

.assigned-recipe{
margin-top:auto;
padding:.5rem .75rem;
background:var(--accent-gradient);
border-radius:var(--radius-sm);
font-size:.8rem;
font-weight:600;
color:#fff;
position:relative;
padding-right:2rem;
word-break:break-word;
box-shadow:var(--shadow-sm);
}

.clear-btn{
position:absolute;
top:50%;
right:.5rem;
transform:translateY(-50%);
width:1.5rem;
height:1.5rem;
display:flex;
align-items:center;
justify-content:center;
background:rgba(255,255,255,.2);
border-radius:50%;
cursor:pointer;
font-size:.9rem;
font-weight:700;
color:#fff;
transition:all .2s;
}

.clear-btn:hover{
background:rgba(255,255,255,.3);
transform:translateY(-50%) scale(1.1);
}

.day-card.drag-over{
background:var(--success);
background:rgba(16,185,129,.2);
border-color:var(--success);
border-width:2px;
border-style:dashed;
transform:scale(1.02);
box-shadow:0 0 20px rgba(16,185,129,.3);
}

.day-card.drop-success{
animation:dropSuccess .6s ease-out;
}

@keyframes dropSuccess{
0%{
background:var(--success);
transform:scale(1.05);
}
100%{
background:var(--bg-secondary);
transform:scale(1);
}
}

.recipe-details{
background:var(--card-bg);
backdrop-filter:blur(20px) saturate(180%);
-webkit-backdrop-filter:blur(20px) saturate(180%);
border-radius:var(--radius-xl);
padding:var(--spacing-xl);
margin-top:var(--spacing-xl);
border:1px solid var(--card-border);
box-shadow:var(--shadow-lg);
}

.recipe-details h2{
font-size:1.75rem;
font-weight:700;
background:var(--accent-gradient);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
background-clip:text;
margin:0 0 var(--spacing-lg);
}

.recipe-details h5{
font-size:1.1rem;
font-weight:600;
color:var(--text-primary);
margin:var(--spacing-lg) 0 var(--spacing-md);
display:flex;
align-items:center;
gap:var(--spacing-sm);
}

.recipe-details ul,
.recipe-details ol{
margin:0 0 var(--spacing-lg);
padding-left:var(--spacing-lg);
}

.recipe-details li{
margin-bottom:var(--spacing-sm);
color:var(--text-secondary);
line-height:1.6;
}

.recipe-details li::marker{
color:var(--accent-primary);
}

.empty-state{
text-align:center;
padding:var(--spacing-xl);
color:var(--text-muted);
}

.empty-state i{
font-size:3rem;
margin-bottom:var(--spacing-md);
opacity:.5;
}

.modal-content{
background:var(--bg-secondary);
border:1px solid var(--card-border);
border-radius:var(--radius-xl);
color:var(--text-primary);
box-shadow:var(--shadow-xl);
}

.modal-header{
border-bottom:1px solid var(--card-border);
padding:var(--spacing-lg) var(--spacing-xl);
}

.modal-body{
padding:var(--spacing-xl);
max-height:70vh;
overflow-y:auto;
}

.modal-footer{
border-top:1px solid var(--card-border);
padding:var(--spacing-lg) var(--spacing-xl);
}

.modal-title{
font-weight:600;
font-size:1.25rem;
}

.form-label{
font-weight:500;
color:var(--text-primary);
margin-bottom:var(--spacing-sm);
font-size:.9rem;
}

.form-control{
background:var(--card-bg);
border:1px solid var(--card-border);
border-radius:var(--radius-md);
color:var(--text-primary);
padding:.75rem 1rem;
font-size:.9rem;
transition:all .2s;
}

.form-control:focus{
background:var(--card-bg-hover);
border-color:var(--accent-primary);
box-shadow:0 0 0 3px rgba(59,130,246,.1);
color:var(--text-primary);
outline:none;
}

.form-control::placeholder{
color:var(--text-muted);
}

/* NEW: Image upload preview styles */
.image-upload-area{
border:2px dashed var(--card-border);
border-radius:var(--radius-md);
padding:var(--spacing-lg);
text-align:center;
cursor:pointer;
transition:all .2s;
background:var(--card-bg);
}

.image-upload-area:hover{
border-color:var(--accent-primary);
background:var(--card-bg-hover);
}

.image-upload-area.has-image{
border-style:solid;
padding:0;
}

.image-preview{
width:100%;
max-height:200px;
object-fit:cover;
border-radius:var(--radius-md);
}

.image-actions{
display:flex;
gap:var(--spacing-sm);
justify-content:center;
margin-top:var(--spacing-sm);
}

/* NEW: Drag-to-reorder list styles */
.draggable-list{
list-style:none;
padding:0;
margin:0;
}

.draggable-item{
background:var(--card-bg);
border:1px solid var(--card-border);
border-radius:var(--radius-sm);
padding:var(--spacing-sm) var(--spacing-md);
margin-bottom:var(--spacing-xs);
display:flex;
align-items:center;
gap:var(--spacing-sm);
cursor:move;
transition:all .2s;
}

.draggable-item:hover{
background:var(--card-bg-hover);
border-color:var(--accent-primary);
}

.draggable-item.dragging{
opacity:.5;
}

.draggable-item.drag-over{
border-top:3px solid var(--accent-primary);
}

.drag-handle{
color:var(--text-muted);
cursor:grab;
font-size:1.1rem;
}

.drag-handle:active{
cursor:grabbing;
}

.draggable-item-content{
flex:1;
color:var(--text-primary);
}

.draggable-item-remove{
color:var(--danger);
cursor:pointer;
font-size:1.1rem;
opacity:.7;
transition:opacity .2s;
}

.draggable-item-remove:hover{
opacity:1;
}

.add-item-input{
display:flex;
gap:var(--spacing-sm);
margin-top:var(--spacing-sm);
}

.add-item-input input{
flex:1;
}

.offcanvas{
background:var(--bg-primary);
border-right:1px solid var(--card-border);
max-width:90vw;
}

.offcanvas-header{
border-bottom:1px solid var(--card-border);
padding:var(--spacing-lg);
}

.offcanvas-body{
padding:var(--spacing-lg);
}

.btn-close{
filter:invert(1);
opacity:.8;
}

.shopping-list{
display:flex;
flex-direction:column;
gap:var(--spacing-sm);
}

.shopping-item{
display:flex;
align-items:center;
gap:var(--spacing-md);
padding:var(--spacing-md);
background:var(--card-bg);
border:1px solid var(--card-border);
border-radius:var(--radius-md);
transition:all .2s;
}

.shopping-item:hover{
background:var(--card-bg-hover);
}

.shopping-item input[type="checkbox"]{
width:20px;
height:20px;
cursor:pointer;
accent-color:var(--success);
}

.shopping-item.checked{
opacity:.5;
text-decoration:line-through;
}

.shopping-item-text{
flex:1;
}

.mobile-assign-banner{
position:fixed;
bottom:calc(var(--safe-area-inset-bottom) + var(--spacing-md));
left:50%;
transform:translateX(-50%);
width:calc(100% - 2rem);
max-width:500px;
background:var(--accent-gradient);
color:#fff;
padding:var(--spacing-md) var(--spacing-lg);
border-radius:var(--radius-xl);
box-shadow:var(--shadow-xl);
display:none;
align-items:center;
justify-content:space-between;
gap:var(--spacing-md);
z-index:1000;
font-weight:600;
animation:slideUpBanner .3s ease-out;
}

@keyframes slideUpBanner{
from{
transform:translateX(-50%) translateY(150px);
opacity:0;
}
to{
transform:translateX(-50%) translateY(0);
opacity:1;
}
}

.mobile-assign-banner.active{
display:flex;
}

.mobile-assign-banner-content{
flex:1;
display:flex;
align-items:center;
gap:var(--spacing-sm);
}

.mobile-assign-banner-icon{
font-size:1.5rem;
}

.mobile-assign-banner button{
background:rgba(255,255,255,.2);
border:none;
color:#fff;
padding:.5rem 1rem;
border-radius:var(--radius-md);
font-weight:600;
cursor:pointer;
transition:all .2s;
white-space:nowrap;
}

.mobile-assign-banner button:hover{
background:rgba(255,255,255,.3);
}

.toast-notification{
position:fixed;
top:calc(var(--safe-area-inset-top) + var(--spacing-lg));
right:var(--spacing-lg);
background:var(--bg-secondary);
border:1px solid var(--card-border);
border-radius:var(--radius-lg);
padding:var(--spacing-md) var(--spacing-lg);
box-shadow:var(--shadow-xl);
display:flex;
align-items:center;
gap:var(--spacing-md);
min-width:300px;
max-width:400px;
z-index:10000;
animation:slideInRight .3s ease-out;
}

@keyframes slideInRight{
from{
transform:translateX(500px);
opacity:0;
}
to{
transform:translateX(0);
opacity:1;
}
}

@keyframes slideOutRight{
from{
transform:translateX(0);
opacity:1;
}
to{
transform:translateX(500px);
opacity:0;
}
}

.toast-notification.success{
border-left:4px solid var(--success);
}

.toast-notification.error{
border-left:4px solid var(--danger);
}

.toast-notification.info{
border-left:4px solid var(--accent-primary);
}

.toast-icon{
font-size:1.5rem;
}

@media (max-width:768px){
.main-wrapper{
grid-template-columns:1fr;
gap:var(--spacing-md);
}

.sidebar{
display:none;
}

.toolbar{
position:relative;
top:0;
gap:var(--spacing-xs);
}

.btn-custom{
min-width:auto;
flex:1 1 calc(33.333% - var(--spacing-xs));
font-size:.75rem;
padding:.55rem .6rem;
}

.btn-custom span{
display:none;
}

.btn-custom.show-text span{
display:inline;
}

.calendar{
grid-template-columns:repeat(2,1fr);
gap:var(--spacing-sm);
}

.day-card{
min-height:100px;
padding:var(--spacing-sm);
}

.day-number{
font-size:1.25rem;
}

.weekday-header{
display:none;
}

.day-date{
display:block;
}

.recipe-details{
padding:var(--spacing-lg);
}

.app-container{
padding:var(--spacing-sm);
padding-bottom:calc(var(--safe-area-inset-bottom) + 100px);
}

.toast-notification{
left:var(--spacing-sm);
right:var(--spacing-sm);
min-width:auto;
max-width:none;
}
}

@media (max-width:576px){
.calendar{
grid-template-columns:1fr;
}

.btn-custom{
flex:1 1 calc(50% - var(--spacing-xs));
}
}

@media print{
body{
background:white;
color:black;
}

.toolbar,
.sidebar,
.btn-custom,
.clear-btn,
.offcanvas,
.mobile-assign-banner{
display:none!important;
}

.day-card{
border:1px solid #000;
background:white;
color:black;
}

.calendar{
grid-template-columns:repeat(7,1fr);
}
}
</style>
</head>
<body style="" class="">

<div class="app-container">
<header class="app-header">
<h1 class="app-title">üçΩÔ∏è Meal Planner Pro</h1>
<p class="app-subtitle">Plan your perfect meals</p>
</header>

<div class="toolbar">
<button class="btn-custom d-md-none" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRecipes">
<i class="bi bi-grid-3x3-gap"></i>
<span>Recipes</span>
</button>

<button class="btn-custom btn-primary-custom" id="downloadHtmlBtn">
<i class="bi bi-download"></i>
<span>Save</span>
</button>

<button class="btn-custom btn-success-custom" id="shoppingListBtn">
<i class="bi bi-cart"></i>
<span>Shop</span>
</button>

<button class="btn-custom" id="clearAllBtn">
<i class="bi bi-trash3"></i>
<span>Clear</span>
</button>

<button class="btn-custom" data-bs-toggle="modal" data-bs-target="#addRecipeModal">
<i class="bi bi-plus-circle"></i>
<span>Add</span>
</button>

<button class="btn-custom d-none d-md-flex" id="printBtn">
<i class="bi bi-printer"></i>
<span>Print</span>
</button>
</div>

<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasRecipes">
<div class="offcanvas-header">
<h5 class="offcanvas-title"><i class="bi bi-grid-3x3-gap"></i> Recipe Library</h5>
<button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
</div>
<div class="offcanvas-body">
<div class="search-wrapper">
<i class="bi bi-search"></i>
<input type="text" class="search-box" id="searchBoxMobile" placeholder="Search recipes...">
</div>
<div class="recipe-items" id="recipePaletteMobile"><div class="recipe-item" data-recipe="Beer Brats">
    <div class="recipe-item-content">
      <span class="recipe-icon">üå≠</span>
      <span>Beer Brats</span>
    </div>
    <div class="recipe-item-actions">
      <span class="icon-btn" data-action="edit" title="Edit recipe">
        <i class="bi bi-pencil"></i>
      </span>
    </div>
  </div><div class="recipe-item" data-recipe="Smash Burgers">
    <div class="recipe-item-content">
      <span class="recipe-icon">üçî</span>
      <span>Smash Burgers</span>
    </div>
    <div class="recipe-item-actions">
      <span class="icon-btn" data-action="edit" title="Edit recipe">
        <i class="bi bi-pencil"></i>
      </span>
    </div>
  </div><div class="recipe-item" data-recipe="Smoked Brisket">
    <div class="recipe-item-content">
      <span class="recipe-icon">ü•ì</span>
      <span>Smoked Brisket</span>
    </div>
    <div class="recipe-item-actions">
      <span class="icon-btn" data-action="edit" title="Edit recipe">
        <i class="bi bi-pencil"></i>
      </span>
    </div>
  </div><div class="recipe-item" data-recipe="Smoked Pork Butt">
    <div class="recipe-item-content">
      <span class="recipe-icon">ü•©</span>
      <span>Smoked Pork Butt</span>
    </div>
    <div class="recipe-item-actions">
      <span class="icon-btn" data-action="edit" title="Edit recipe">
        <i class="bi bi-pencil"></i>
      </span>
    </div>
  </div><div class="recipe-item" data-recipe="Tacos">
    <div class="recipe-item-content">
      <span class="recipe-icon">üåÆ</span>
      <span>Tacos</span>
    </div>
    <div class="recipe-item-actions">
      <span class="icon-btn" data-action="edit" title="Edit recipe">
        <i class="bi bi-pencil"></i>
      </span>
    </div>
  </div></div>
</div>
</div>

<div class="main-wrapper">
<aside class="sidebar d-none d-md-block">
<div class="sidebar-header">
<i class="bi bi-grid-3x3-gap"></i>
Recipe Library
</div>
<div class="search-wrapper">
<i class="bi bi-search"></i>
<input type="text" class="search-box" id="searchBoxDesktop" placeholder="Search recipes...">
</div>
<div class="recipe-items" id="recipePaletteDesktop"><div class="recipe-item" data-recipe="Beer Brats">
    <div class="recipe-item-content">
      <span class="recipe-icon">üå≠</span>
      <span>Beer Brats</span>
    </div>
    <div class="recipe-item-actions">
      <span class="icon-btn" data-action="edit" title="Edit recipe">
        <i class="bi bi-pencil"></i>
      </span>
    </div>
  </div><div class="recipe-item" data-recipe="Smash Burgers">
    <div class="recipe-item-content">
      <span class="recipe-icon">üçî</span>
      <span>Smash Burgers</span>
    </div>
    <div class="recipe-item-actions">
      <span class="icon-btn" data-action="edit" title="Edit recipe">
        <i class="bi bi-pencil"></i>
      </span>
    </div>
  </div><div class="recipe-item" data-recipe="Smoked Brisket">
    <div class="recipe-item-content">
      <span class="recipe-icon">ü•ì</span>
      <span>Smoked Brisket</span>
    </div>
    <div class="recipe-item-actions">
      <span class="icon-btn" data-action="edit" title="Edit recipe">
        <i class="bi bi-pencil"></i>
      </span>
    </div>
  </div><div class="recipe-item" data-recipe="Smoked Pork Butt">
    <div class="recipe-item-content">
      <span class="recipe-icon">ü•©</span>
      <span>Smoked Pork Butt</span>
    </div>
    <div class="recipe-item-actions">
      <span class="icon-btn" data-action="edit" title="Edit recipe">
        <i class="bi bi-pencil"></i>
      </span>
    </div>
  </div><div class="recipe-item" data-recipe="Tacos">
    <div class="recipe-item-content">
      <span class="recipe-icon">üåÆ</span>
      <span>Tacos</span>
    </div>
    <div class="recipe-item-actions">
      <span class="icon-btn" data-action="edit" title="Edit recipe">
        <i class="bi bi-pencil"></i>
      </span>
    </div>
  </div></div>
</aside>

<section>
<div class="calendar-wrapper">
<div class="weekday-header d-none d-md-grid">
<div class="weekday-label">Sunday</div>
<div class="weekday-label">Monday</div>
<div class="weekday-label">Tuesday</div>
<div class="weekday-label">Wednesday</div>
<div class="weekday-label">Thursday</div>
<div class="weekday-label">Friday</div>
<div class="weekday-label">Saturday</div>
</div>
<div class="calendar" id="calendar"><div class="day-card outside-trip" data-iso="2025-12-14"><div class="day-date d-md-none">Sun</div><div class="day-number">14</div></div><div class="day-card outside-trip" data-iso="2025-12-15"><div class="day-date d-md-none">Mon</div><div class="day-number">15</div></div><div class="day-card outside-trip" data-iso="2025-12-16"><div class="day-date d-md-none">Tue</div><div class="day-number">16</div></div><div class="day-card outside-trip" data-iso="2025-12-17"><div class="day-date d-md-none">Wed</div><div class="day-number">17</div></div><div class="day-card" data-iso="2025-12-18"><div class="day-date d-md-none">Thu</div><div class="day-number">18</div></div><div class="day-card" data-iso="2025-12-19"><div class="day-date d-md-none">Fri</div><div class="day-number">19</div></div><div class="day-card" data-iso="2025-12-20"><div class="day-date d-md-none">Sat</div><div class="day-number">20</div></div><div class="day-card drop-success" data-iso="2025-12-21"><div class="day-date d-md-none">Sun</div><div class="day-number">21</div><div class="assigned-recipe"><span>üå≠ Beer Brats</span><span class="clear-btn">√ó</span></div></div><div class="day-card drop-success" data-iso="2025-12-22"><div class="day-date d-md-none">Mon</div><div class="day-number">22</div><div class="assigned-recipe"><span>üå≠ Beer Brats</span><span class="clear-btn">√ó</span></div></div><div class="day-card drop-success" data-iso="2025-12-23"><div class="day-date d-md-none">Tue</div><div class="day-number">23</div><div class="assigned-recipe"><span>üå≠ Beer Brats</span><span class="clear-btn">√ó</span></div></div><div class="day-card drop-success" data-iso="2025-12-24"><div class="day-date d-md-none">Wed</div><div class="day-number">24</div><div class="assigned-recipe"><span>üå≠ Beer Brats</span><span class="clear-btn">√ó</span></div></div><div class="day-card drop-success" data-iso="2025-12-25"><div class="day-date d-md-none">Thu</div><div class="day-number">25</div><div class="assigned-recipe"><span>üå≠ Beer Brats</span><span class="clear-btn">√ó</span></div></div><div class="day-card" data-iso="2025-12-26"><div class="day-date d-md-none">Fri</div><div class="day-number">26</div></div><div class="day-card" data-iso="2025-12-27"><div class="day-date d-md-none">Sat</div><div class="day-number">27</div></div><div class="day-card" data-iso="2025-12-28"><div class="day-date d-md-none">Sun</div><div class="day-number">28</div></div><div class="day-card outside-trip" data-iso="2025-12-29"><div class="day-date d-md-none">Mon</div><div class="day-number">29</div></div><div class="day-card outside-trip" data-iso="2025-12-30"><div class="day-date d-md-none">Tue</div><div class="day-number">30</div></div><div class="day-card outside-trip" data-iso="2025-12-31"><div class="day-date d-md-none">Wed</div><div class="day-number">31</div></div><div class="day-card outside-trip" data-iso="2026-01-01"><div class="day-date d-md-none">Thu</div><div class="day-number">1</div></div><div class="day-card outside-trip" data-iso="2026-01-02"><div class="day-date d-md-none">Fri</div><div class="day-number">2</div></div><div class="day-card outside-trip" data-iso="2026-01-03"><div class="day-date d-md-none">Sat</div><div class="day-number">3</div></div></div>
</div>

<div class="recipe-details" id="recipeDetails">
<div class="empty-state">
<i class="bi bi-cursor"></i>
<p><strong>üì± Mobile:</strong> Tap recipe ‚Üí Tap day to assign</p>
<p><strong>üñ±Ô∏è Desktop:</strong> Drag recipe onto day</p>
<p><small>Click any assigned day to view the full recipe</small></p>
</div>
</div>
</section>
</div>
</div>

<div class="mobile-assign-banner" id="mobileAssignBanner">
<div class="mobile-assign-banner-content">
<span class="mobile-assign-banner-icon">üëâ</span>
<div>
<div style="font-size:.85rem;opacity:.9;">Selected:</div>
<div id="selectedRecipeName">Recipe</div>
</div>
</div>
<button id="cancelAssignBtn">Cancel</button>
</div>

<!-- Recipe Modal with NEW image upload and drag-to-reorder -->
<div class="modal fade" id="addRecipeModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="recipeModalTitle"><i class="bi bi-plus-circle"></i> Add Recipe</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<form id="addRecipeForm">
<input type="hidden" id="editingRecipeKey">
<input type="hidden" id="recipeImageData">
<div class="mb-3">
<label class="form-label">Recipe Name (unique)</label>
<input type="text" class="form-control" id="newKey" placeholder="e.g., Mom's Lasagna" required="">
</div>
<div class="mb-3">
<label class="form-label">Display Title</label>
<input type="text" class="form-control" id="newTitle" placeholder="e.g., Classic Homemade Lasagna" required="">
</div>
<div class="mb-3">
<label class="form-label">Recipe Image (optional)</label>
<div class="image-upload-area" id="imageUploadArea">
<input type="file" id="imageUpload" accept="image/*" style="display:none;">
<div id="imageUploadPrompt">
<i class="bi bi-image" style="font-size:2rem;opacity:.5;"></i>
<p style="margin:.5rem 0 0;color:var(--text-muted);">Click to upload image</p>
<small style="color:var(--text-muted);">Max 500KB recommended</small>
</div>
<img id="imagePreview" class="image-preview" style="display:none;">
</div>
<div class="image-actions" id="imageActions" style="display:none;">
<button type="button" class="btn btn-sm btn-secondary" id="changeImageBtn">Change Image</button>
<button type="button" class="btn btn-sm btn-danger" id="removeImageBtn">Remove</button>
</div>
</div>
<div class="mb-3">
<label class="form-label">Ingredients <small class="text-muted">(drag to reorder)</small></label>
<ul class="draggable-list" id="ingredientsList"></ul>
<div class="add-item-input">
<input type="text" class="form-control" id="newIngredient" placeholder="Add ingredient...">
<button type="button" class="btn btn-primary" id="addIngredientBtn">
<i class="bi bi-plus"></i>
</button>
</div>
</div>
<div class="mb-3">
<label class="form-label">Cooking Steps <small class="text-muted">(drag to reorder)</small></label>
<ol class="draggable-list" id="stepsList"></ol>
<div class="add-item-input">
<input type="text" class="form-control" id="newStep" placeholder="Add step...">
<button type="button" class="btn btn-primary" id="addStepBtn">
<i class="bi bi-plus"></i>
</button>
</div>
</div>
<div class="mb-3">
<label class="form-label">Tips &amp; Notes <small class="text-muted">(drag to reorder)</small></label>
<ul class="draggable-list" id="tipsList"></ul>
<div class="add-item-input">
<input type="text" class="form-control" id="newTip" placeholder="Add tip...">
<button type="button" class="btn btn-primary" id="addTipBtn">
<i class="bi bi-plus"></i>
</button>
</div>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button type="button" class="btn btn-danger" id="deleteRecipeBtn" style="display:none;margin-right:auto;">
<i class="bi bi-trash"></i> Delete
</button>
<button type="button" class="btn btn-primary" id="saveRecipeBtn">
<i class="bi bi-check-circle"></i> <span id="saveBtnText">Save Recipe</span>
</button>
</div>
</div>
</div>
</div>

<div class="modal fade" id="shoppingListModal" tabindex="-1" style="display: none;" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title"><i class="bi bi-cart"></i> Grocery List</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>
<div class="modal-body">
<div id="shoppingListContent" class="shopping-list">
      <div class="shopping-item" id="shop-0">
        <input type="checkbox" id="check-0" onchange="document.getElementById('shop-0').classList.toggle('checked')">
        <label for="check-0" class="shopping-item-text">
          1 large onion, sliced
        </label>
      </div>
    
      <div class="shopping-item" id="shop-1">
        <input type="checkbox" id="check-1" onchange="document.getElementById('shop-1').classList.toggle('checked')">
        <label for="check-1" class="shopping-item-text">
          1 Tbsp mustard seeds
        </label>
      </div>
    
      <div class="shopping-item" id="shop-2">
        <input type="checkbox" id="check-2" onchange="document.getElementById('shop-2').classList.toggle('checked')">
        <label for="check-2" class="shopping-item-text">
          12 bratwurst links
        </label>
      </div>
    
      <div class="shopping-item" id="shop-3">
        <input type="checkbox" id="check-3" onchange="document.getElementById('shop-3').classList.toggle('checked')">
        <label for="check-3" class="shopping-item-text">
          2 cups lager
        </label>
      </div>
    
      <div class="shopping-item" id="shop-4">
        <input type="checkbox" id="check-4" onchange="document.getElementById('shop-4').classList.toggle('checked')">
        <label for="check-4" class="shopping-item-text">
          2 Tbsp butter
        </label>
      </div>
    
      <div class="shopping-item" id="shop-5">
        <input type="checkbox" id="check-5" onchange="document.getElementById('shop-5').classList.toggle('checked')">
        <label for="check-5" class="shopping-item-text">
          Buns, sauerkraut, mustard
        </label>
      </div>
    
      <div class="shopping-item" id="shop-6">
        <input type="checkbox" id="check-6" onchange="document.getElementById('shop-6').classList.toggle('checked')">
        <label for="check-6" class="shopping-item-text">
          Olive oil
        </label>
      </div>
    </div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
<button type="button" class="btn btn-success" id="exportGroceryTxtBtn">
<i class="bi bi-file-earmark-text"></i> Export TXT
</button>
<button type="button" class="btn btn-primary" id="copyGroceryBtn">
<i class="bi bi-clipboard"></i> Copy
</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const tripStart = new Date(2025, 11, 18);
const tripEnd = new Date(2025, 11, 28);
const startOfWeek = new Date(tripStart);
startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
const endOfWeek = new Date(tripEnd);
endOfWeek.setDate(endOfWeek.getDate() + (6 - endOfWeek.getDay()));

const recipeIcons = {
'Smoked Pork Butt': 'ü•©',
'Beer Brats': 'üå≠',
'Smash Burgers': 'üçî',
'Smoked Brisket': 'ü•ì',
'Tacos': 'üåÆ',
'default': 'üçΩÔ∏è'
};

let recipes = {
  "Smoked Pork Butt": {
    "title": "Smoked Pork Butt (Pulled Pork)",
    "icon": "ü•©",
    "ingredients": [
      "5-lb pork shoulder",
      "2 Tbsp kosher salt",
      "2 Tbsp brown sugar",
      "1 Tbsp paprika",
      "1 Tbsp black pepper",
      "1 Tbsp garlic powder",
      "1 Tbsp onion powder",
      "¬Ω Tbsp cayenne (optional)",
      "Applewood or hickory wood chips"
    ],
    "steps": [
      "Trim excess fat, then apply dry rub.",
      "Preheat smoker to 225¬∞F and add wood.",
      "Place pork butt fat side up.",
      "Smoke until 165-170¬∞F (5-6 h).",
      "Wrap tightly in foil.",
      "Continue until 195-205¬∞F (2-3 h).",
      "Rest 30-45 min, then shred.",
      "Serve with coleslaw and buns."
    ],
    "tips": [
      "Maintain steady 225¬∞F.",
      "Digital probe helps monitor temp.",
      "Applewood = sweet, hickory = stronger."
    ]
  },
  "Beer Brats": {
    "title": "Beer-Braised Bratwurst",
    "icon": "üå≠",
    "ingredients": [
      "12 bratwurst links",
      "2 cups lager",
      "1 large onion, sliced",
      "2 Tbsp butter",
      "1 Tbsp mustard seeds",
      "Olive oil",
      "Buns, sauerkraut, mustard"
    ],
    "steps": [
      "Melt butter, saut√© onions.",
      "Add mustard seeds and brats.",
      "Pour beer, simmer covered 15-20 min.",
      "Remove brats, brown each side.",
      "Serve on buns with toppings."
    ],
    "tips": [
      "Use robust lager.",
      "Internal temp should hit 160¬∞F."
    ]
  },
  "Smash Burgers": {
    "title": "Smash Burgers",
    "icon": "üçî",
    "ingredients": [
      "1 lb ground beef (80/20)",
      "Salt & pepper",
      "4 burger buns",
      "Cheddar slices",
      "Pickles, lettuce, tomato, onion",
      "Butter",
      "High smoke-point oil"
    ],
    "steps": [
      "Form 4 loose balls.",
      "Heat griddle to 450-500¬∞F.",
      "Smash thin with spatula.",
      "Season, cook 2-3 min, flip, add cheese.",
      "Toast buns, assemble."
    ],
    "tips": [
      "Thin patty = better crust.",
      "Heavy spatula for even smash."
    ]
  },
  "Smoked Brisket": {
    "title": "Smoked Beef Brisket",
    "icon": "ü•ì",
    "ingredients": [
      "10-lb brisket",
      "2 Tbsp kosher salt",
      "2 Tbsp black pepper",
      "1 Tbsp garlic powder",
      "1 Tbsp onion powder",
      "Hickory or oak chunks",
      "Apple juice (optional)"
    ],
    "steps": [
      "Trim fat to ¬º-inch.",
      "Apply rub liberally.",
      "Preheat smoker to 225¬∞F.",
      "Smoke until 165-170¬∞F (6-8 h).",
      "Wrap in foil.",
      "Continue to 195-203¬∞F (2-3 h).",
      "Rest 1-2 h, slice."
    ],
    "tips": [
      "Consistent 225¬∞F is key.",
      "Wrapping speeds stall.",
      "Resting = juicy slices."
    ]
  },
  "Tacos": {
    "title": "Grilled Chicken & Steak Tacos",
    "icon": "üåÆ",
    "ingredients": [
      "1 lb chicken breast",
      "1 lb flank steak",
      "2 Tbsp olive oil",
      "1 Tbsp chili powder",
      "1 tsp cumin",
      "1 tsp smoked paprika",
      "Salt & pepper",
      "12 corn tortillas",
      "Cilantro, onion, lime, salsa, avocado"
    ],
    "steps": [
      "Toss meat in oil + spices, rest 15 min.",
      "Grill at 450¬∞F ‚Äì chicken 4-5 min, steak 3-4 min per side.",
      "Rest 5 min, slice.",
      "Warm tortillas, fill with meat and toppings."
    ],
    "tips": [
      "Oak/hickory for char.",
      "Slice against grain."
    ]
  }
};

let assignments = {
  "2025-12-21": "Beer Brats",
  "2025-12-22": "Beer Brats",
  "2025-12-23": "Beer Brats",
  "2025-12-24": "Beer Brats",
  "2025-12-25": "Beer Brats"
};

const STORAGE_KEY = 'meal-planner-v4';
const RECIPES_KEY = 'meal-planner-recipes-v4';
let isMobile = false;
let selectedRecipeForAssign = null;
let activeToasts = new Set();

const calendarEl = document.getElementById('calendar');
const recipeDetails = document.getElementById('recipeDetails');
const paletteDesktop = document.getElementById('recipePaletteDesktop');
const paletteMobile = document.getElementById('recipePaletteMobile');
const mobileAssignBanner = document.getElementById('mobileAssignBanner');
const selectedRecipeName = document.getElementById('selectedRecipeName');

function detectMobile() {
  return window.innerWidth < 768;
}

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast-notification ${type}`;
  const icons = { success: '‚úì', error: '‚úï', info: '‚Ñπ' };
  toast.innerHTML = `<span class="toast-icon">${icons[type] || icons.info}</span><span>${message}</span>`;
  document.body.appendChild(toast);
  activeToasts.add(toast);

  const dismissTimer = setTimeout(() => {
    toast.style.animation = 'slideOutRight .3s ease-out';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.remove();
        activeToasts.delete(toast);
      }
    }, 300);
  }, 3000);

  toast._dismissTimer = dismissTimer;
}

function loadData() {
  try {
    const savedAssignments = localStorage.getItem(STORAGE_KEY);
    if (savedAssignments) assignments = JSON.parse(savedAssignments);
    const savedRecipes = localStorage.getItem(RECIPES_KEY);
    if (savedRecipes) recipes = { ...recipes, ...JSON.parse(savedRecipes) };
  } catch (e) {
    console.error('Error loading data:', e);
    trackEvent('Error', 'load_data_failed', e.message);
  }
}

function saveAssignments() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(assignments));
  trackEvent('Data', 'save_assignments', Object.keys(assignments).length);
}

function saveRecipes() {
  localStorage.setItem(RECIPES_KEY, JSON.stringify(recipes));
  trackEvent('Data', 'save_recipes', Object.keys(recipes).length);
}

function isInTrip(date) { return date >= tripStart && date <= tripEnd; }
function isToday(date) {
  const today = new Date();
  return date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
}
function formatDate(date) { return `${date.getMonth() + 1}/${date.getDate()}`; }
function getWeekday(date) { return date.toLocaleDateString('en-US', { weekday: 'short' }); }

// NEW: Image upload handler
function setupImageUpload() {
  const uploadArea = document.getElementById('imageUploadArea');
  const fileInput = document.getElementById('imageUpload');
  const preview = document.getElementById('imagePreview');
  const prompt = document.getElementById('imageUploadPrompt');
  const actions = document.getElementById('imageActions');
  const imageDataInput = document.getElementById('recipeImageData');

  uploadArea.addEventListener('click', () => {
    if (!uploadArea.classList.contains('has-image')) {
      fileInput.click();
    }
  });

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 2000000) { // 2MB limit
        showToast('Image too large! Please use image under 2MB', 'error');
        trackEvent('Image', 'upload_failed', 'file_too_large');
        return;
      }

      const reader = new FileReader();
      reader.onload = (event) => {
        const base64 = event.target.result;
        imageDataInput.value = base64;
        preview.src = base64;
        preview.style.display = 'block';
        prompt.style.display = 'none';
        uploadArea.classList.add('has-image');
        actions.style.display = 'flex';
        trackEvent('Image', 'upload_success', file.size);
      };
      reader.readAsDataURL(file);
    }
  });

  document.getElementById('changeImageBtn').addEventListener('click', (e) => {
    e.stopPropagation();
    fileInput.click();
  });

  document.getElementById('removeImageBtn').addEventListener('click', (e) => {
    e.stopPropagation();
    imageDataInput.value = '';
    preview.src = '';
    preview.style.display = 'none';
    prompt.style.display = 'block';
    uploadArea.classList.remove('has-image');
    actions.style.display = 'none';
    fileInput.value = '';
    trackEvent('Image', 'remove', 'manual');
  });
}

// NEW: Drag-to-reorder functionality
function makeDraggable(listElement, onReorder) {
  let draggedElement = null;

  listElement.addEventListener('dragstart', (e) => {
    if (e.target.classList.contains('draggable-item')) {
      draggedElement = e.target;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
  });

  listElement.addEventListener('dragend', (e) => {
    if (e.target.classList.contains('draggable-item')) {
      e.target.classList.remove('dragging');
      listElement.querySelectorAll('.draggable-item').forEach(item => {
        item.classList.remove('drag-over');
      });
      if (onReorder) onReorder();
    }
  });

  listElement.addEventListener('dragover', (e) => {
    e.preventDefault();
    const afterElement = getDragAfterElement(listElement, e.clientY);
    if (afterElement == null) {
      listElement.appendChild(draggedElement);
    } else {
      listElement.insertBefore(draggedElement, afterElement);
    }
  });
}

function getDragAfterElement(container, y) {
  const draggableElements = [...container.querySelectorAll('.draggable-item:not(.dragging)')];
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function createDraggableItem(text, onRemove) {
  const li = document.createElement('li');
  li.className = 'draggable-item';
  li.draggable = true;
  li.innerHTML = `
    <i class="bi bi-grip-vertical drag-handle"></i>
    <span class="draggable-item-content">${text}</span>
    <i class="bi bi-x-circle draggable-item-remove"></i>
  `;
  li.querySelector('.draggable-item-remove').addEventListener('click', () => {
    li.remove();
    if (onRemove) onRemove();
    trackEvent('Recipe', 'remove_item', 'draggable_list');
  });
  return li;
}

function populateDraggableList(listId, items) {
  const list = document.getElementById(listId);
  list.innerHTML = '';
  items.forEach(item => {
    list.appendChild(createDraggableItem(item));
  });
}

function getDraggableListValues(listId) {
  const list = document.getElementById(listId);
  return Array.from(list.querySelectorAll('.draggable-item-content')).map(el => el.textContent);
}

function setupDraggableLists() {
  makeDraggable(document.getElementById('ingredientsList'), () => {
    trackEvent('Recipe', 'reorder_ingredients', 'drag');
  });
  makeDraggable(document.getElementById('stepsList'), () => {
    trackEvent('Recipe', 'reorder_steps', 'drag');
  });
  makeDraggable(document.getElementById('tipsList'), () => {
    trackEvent('Recipe', 'reorder_tips', 'drag');
  });

  document.getElementById('addIngredientBtn').addEventListener('click', () => {
    const input = document.getElementById('newIngredient');
    if (input.value.trim()) {
      document.getElementById('ingredientsList').appendChild(createDraggableItem(input.value.trim()));
      input.value = '';
      trackEvent('Recipe', 'add_ingredient', 'button');
    }
  });

  document.getElementById('newIngredient').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('addIngredientBtn').click();
    }
  });

  document.getElementById('addStepBtn').addEventListener('click', () => {
    const input = document.getElementById('newStep');
    if (input.value.trim()) {
      document.getElementById('stepsList').appendChild(createDraggableItem(input.value.trim()));
      input.value = '';
      trackEvent('Recipe', 'add_step', 'button');
    }
  });

  document.getElementById('newStep').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('addStepBtn').click();
    }
  });

  document.getElementById('addTipBtn').addEventListener('click', () => {
    const input = document.getElementById('newTip');
    if (input.value.trim()) {
      document.getElementById('tipsList').appendChild(createDraggableItem(input.value.trim()));
      input.value = '';
      trackEvent('Recipe', 'add_tip', 'button');
    }
  });

  document.getElementById('newTip').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('addTipBtn').click();
    }
  });
}

function createRecipeItem(name) {
  const recipe = recipes[name];
  const div = document.createElement('div');
  div.className = 'recipe-item';
  div.dataset.recipe = name;
  const icon = recipe.icon || recipeIcons[name] || recipeIcons.default;
  
  // NEW: Show thumbnail if image exists
  const imageHtml = recipe.image 
    ? `<img src="${recipe.image}" class="recipe-thumbnail" alt="${name}">`
    : `<span class="recipe-icon">${icon}</span>`;
  
  div.innerHTML = `
    <div class="recipe-item-content">
      ${imageHtml}
      <span>${name}</span>
    </div>
    <div class="recipe-item-actions">
      <span class="icon-btn" data-action="edit" title="Edit recipe">
        <i class="bi bi-pencil"></i>
      </span>
    </div>
  `;

  div.querySelector('[data-action="edit"]').addEventListener('click', (e) => {
    e.stopPropagation();
    openEditRecipeModal(name);
    trackEvent('Recipe', 'edit_clicked', name);
  });

  if (!isMobile) {
    let ghost = null;
    let currentDropTarget = null;
    const startDrag = ev => {
      ev.preventDefault();
      const recipeName = div.dataset.recipe;
      ghost = div.cloneNode(true);
      ghost.classList.add('dragging');
      ghost.style.cssText = `position:fixed;left:${ev.clientX-50}px;top:${ev.clientY-20}px;pointer-events:none;opacity:.8;z-index:10000;width:200px;`;
      document.body.appendChild(ghost);
      trackEvent('Recipe', 'drag_start', recipeName);

      const move = me => {
        ghost.style.left = me.clientX - 50 + 'px';
        ghost.style.top = me.clientY - 20 + 'px';
        const dropTarget = document.elementFromPoint(me.clientX, me.clientY);
        const dayCard = dropTarget?.closest('.day-card');
        if (currentDropTarget && currentDropTarget !== dayCard) currentDropTarget.classList.remove('drag-over');
        if (dayCard && !dayCard.classList.contains('outside-trip')) {
          dayCard.classList.add('drag-over');
          currentDropTarget = dayCard;
        } else currentDropTarget = null;
      };

      const end = me => {
        document.removeEventListener('pointermove', move);
        document.removeEventListener('pointerup', end);
        if (ghost) ghost.remove();
        if (currentDropTarget) {
          currentDropTarget.classList.remove('drag-over');
          const iso = currentDropTarget.dataset.iso;
          assignments[iso] = recipeName;
          saveAssignments();
          updateCardAssignment(currentDropTarget, recipeName);
          currentDropTarget.classList.add('drop-success');
          setTimeout(() => currentDropTarget.classList.remove('drop-success'), 600);
          showToast(`${recipeName} added to ${formatDate(new Date(iso))}`, 'success');
          trackEvent('Assignment', 'drag_drop', recipeName);
        }
        currentDropTarget = null;
      };

      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', end);
    };
    div.addEventListener('pointerdown', startDrag);
  } else {
    div.addEventListener('click', (e) => {
      if (e.target.closest('.icon-btn')) return;
      selectedRecipeForAssign = name;
      selectedRecipeName.textContent = name;
      mobileAssignBanner.classList.add('active');
      document.querySelectorAll('.recipe-item').forEach(item => item.classList.remove('selected-for-assign'));
      div.classList.add('selected-for-assign');
      document.querySelectorAll('.day-card:not(.outside-trip)').forEach(card => card.classList.add('can-assign'));
      trackEvent('Recipe', 'select_mobile', name);
    });
  }

  return div;
}

function buildPalette() {
  isMobile = detectMobile();
  paletteDesktop.innerHTML = '';
  paletteMobile.innerHTML = '';
  Object.keys(recipes).sort().forEach(name => {
    paletteDesktop.appendChild(createRecipeItem(name));
    paletteMobile.appendChild(createRecipeItem(name));
  });
  attachSearch('searchBoxDesktop', paletteDesktop);
  attachSearch('searchBoxMobile', paletteMobile);
  trackEvent('UI', 'build_palette', Object.keys(recipes).length);
}

function attachSearch(boxId, container) {
  const box = document.getElementById(boxId);
  if (!box) return;
  box.addEventListener('input', () => {
    const term = box.value.trim().toLowerCase();
    container.querySelectorAll('.recipe-item').forEach(it => {
      it.style.display = it.dataset.recipe.toLowerCase().includes(term) ? '' : 'none';
    });
    trackEvent('Search', 'recipe_search', term);
  });
}

function buildCalendar() {
  calendarEl.innerHTML = '';
  for (let d = new Date(startOfWeek); d <= endOfWeek; d.setDate(d.getDate() + 1)) {
    const cur = new Date(d);
    const iso = cur.toISOString().split('T')[0];
    const card = document.createElement('div');
    card.className = 'day-card';
    card.dataset.iso = iso;
    if (!isInTrip(cur)) card.classList.add('outside-trip');
    if (isToday(cur)) card.classList.add('today');

    const dateDiv = document.createElement('div');
    dateDiv.className = 'day-date d-md-none';
    dateDiv.textContent = getWeekday(cur);
    card.appendChild(dateDiv);

    const numberDiv = document.createElement('div');
    numberDiv.className = 'day-number';
    numberDiv.textContent = cur.getDate();
    card.appendChild(numberDiv);

    if (assignments[iso]) updateCardAssignment(card, assignments[iso]);

    card.addEventListener('click', () => {
      if (isMobile && selectedRecipeForAssign && !card.classList.contains('outside-trip')) {
        assignments[iso] = selectedRecipeForAssign;
        saveAssignments();
        updateCardAssignment(card, selectedRecipeForAssign);
        card.classList.add('drop-success');
        setTimeout(() => card.classList.remove('drop-success'), 600);
        showToast(`${selectedRecipeForAssign} added!`, 'success');
        trackEvent('Assignment', 'mobile_tap', selectedRecipeForAssign);
        cancelMobileAssign();
      } else {
        const meal = assignments[iso];
        if (meal) {
          displayRecipe(meal);
          trackEvent('Recipe', 'view_from_calendar', meal);
        }
      }
    });

    calendarEl.appendChild(card);
  }
  trackEvent('UI', 'build_calendar', Object.keys(assignments).length);
}

function updateCardAssignment(card, recipeName) {
  const old = card.querySelector('.assigned-recipe');
  if (old) old.remove();
  const recipe = recipes[recipeName];
  const icon = recipe?.icon || recipeIcons[recipeName] || recipeIcons.default;
  const lbl = document.createElement('div');
  lbl.className = 'assigned-recipe';
  lbl.innerHTML = `<span>${icon} ${recipeName}</span><span class="clear-btn">√ó</span>`;
  lbl.querySelector('.clear-btn').addEventListener('click', ev => {
    ev.stopPropagation();
    delete assignments[card.dataset.iso];
    saveAssignments();
    lbl.remove();
    showToast('Recipe removed', 'info');
    trackEvent('Assignment', 'remove', recipeName);
  });
  card.appendChild(lbl);
}

function cancelMobileAssign() {
  selectedRecipeForAssign = null;
  mobileAssignBanner.classList.remove('active');
  document.querySelectorAll('.recipe-item').forEach(item => item.classList.remove('selected-for-assign'));
  document.querySelectorAll('.day-card').forEach(card => card.classList.remove('can-assign'));
}

document.getElementById('cancelAssignBtn').addEventListener('click', cancelMobileAssign);

function displayRecipe(mealName) {
  const recipe = recipes[mealName];
  if (!recipe) {
    recipeDetails.innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-circle"></i><p>Recipe not found</p></div>`;
    return;
  }
  const icon = recipe.icon || recipeIcons[mealName] || recipeIcons.default;
  
  // NEW: Show large image if exists
  const imageHtml = recipe.image 
    ? `<img src="${recipe.image}" class="recipe-thumbnail-large" alt="${recipe.title}">`
    : '';
  
  recipeDetails.innerHTML = `
    ${imageHtml}
    <h2>${icon} ${recipe.title}</h2>
    <h5><i class="bi bi-basket"></i> Ingredients</h5>
    <ul>${recipe.ingredients.map(i => `<li>${i}</li>`).join('')}</ul>
    <h5><i class="bi bi-list-ol"></i> Instructions</h5>
    <ol>${recipe.steps.map(s => `<li>${s}</li>`).join('')}</ol>
    ${recipe.tips && recipe.tips.length ? `<h5><i class="bi bi-lightbulb"></i> Tips</h5><ul>${recipe.tips.map(t => `<li>${t}</li>`).join('')}</ul>` : ''}
  `;
  if (window.innerWidth < 768) recipeDetails.scrollIntoView({ behavior: 'smooth' });
}

function generateShoppingList() {
  const counts = {};
  Object.values(assignments).forEach(recipeName => {
    const recipe = recipes[recipeName];
    if (recipe) recipe.ingredients.forEach(ing => {
      counts[ing] = (counts[ing] || 0) + 1;
    });
  });
  return Object.entries(counts).map(([ing, count]) => ({ ingredient: ing, count })).sort((a, b) => a.ingredient.localeCompare(b.ingredient));
}

document.getElementById('shoppingListBtn').addEventListener('click', () => {
  const items = generateShoppingList();
  const container = document.getElementById('shoppingListContent');
  if (items.length === 0) {
    container.innerHTML = '<div class="empty-state"><p>No meals assigned yet!</p></div>';
  } else {
    container.innerHTML = items.map((item, idx) => `
      <div class="shopping-item" id="shop-${idx}">
        <input type="checkbox" id="check-${idx}" onchange="document.getElementById('shop-${idx}').classList.toggle('checked')">
        <label for="check-${idx}" class="shopping-item-text">
          ${item.count > 1 ? `<strong>${item.count}x</strong> ` : ''}${item.ingredient}
        </label>
      </div>
    `).join('');
  }
  new bootstrap.Modal(document.getElementById('shoppingListModal')).show();
  trackEvent('Shopping', 'view_list', items.length);
});

document.getElementById('copyGroceryBtn').addEventListener('click', () => {
  const items = generateShoppingList();
  const text = items.map(i => `${i.count > 1 ? i.count + 'x ' : ''}${i.ingredient}`).join('\n');
  navigator.clipboard.writeText(text).then(() => {
    showToast('Copied to clipboard!', 'success');
    trackEvent('Shopping', 'copy_list', items.length);
  }).catch(() => {
    showToast('Copy failed', 'error');
    trackEvent('Error', 'copy_failed', 'shopping_list');
  });
});

document.getElementById('exportGroceryTxtBtn').addEventListener('click', () => {
  const items = generateShoppingList();
  const text = 'üõí GROCERY LIST\n' + '='.repeat(40) + '\n\n' + items.map(i => `${i.count > 1 ? '(' + i.count + 'x) ' : '‚òê '}${i.ingredient}`).join('\n');
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `grocery-list-${new Date().toISOString().split('T')[0]}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Grocery list downloaded!', 'success');
  trackEvent('Shopping', 'export_txt', items.length);
});

function openEditRecipeModal(recipeName) {
  const recipe = recipes[recipeName];
  if (!recipe) return;
  
  document.getElementById('recipeModalTitle').innerHTML = '<i class="bi bi-pencil"></i> Edit Recipe';
  document.getElementById('saveBtnText').textContent = 'Save Changes';
  document.getElementById('deleteRecipeBtn').style.display = 'block';
  document.getElementById('editingRecipeKey').value = recipeName;
  document.getElementById('newKey').value = recipeName;
  document.getElementById('newKey').disabled = true;
  document.getElementById('newTitle').value = recipe.title;
  
  // NEW: Load image if exists
  const imageDataInput = document.getElementById('recipeImageData');
  const preview = document.getElementById('imagePreview');
  const prompt = document.getElementById('imageUploadPrompt');
  const uploadArea = document.getElementById('imageUploadArea');
  const actions = document.getElementById('imageActions');
  
  if (recipe.image) {
    imageDataInput.value = recipe.image;
    preview.src = recipe.image;
    preview.style.display = 'block';
    prompt.style.display = 'none';
    uploadArea.classList.add('has-image');
    actions.style.display = 'flex';
  } else {
    imageDataInput.value = '';
    preview.src = '';
    preview.style.display = 'none';
    prompt.style.display = 'block';
    uploadArea.classList.remove('has-image');
    actions.style.display = 'none';
  }
  
  // NEW: Populate draggable lists
  populateDraggableList('ingredientsList', recipe.ingredients);
  populateDraggableList('stepsList', recipe.steps);
  populateDraggableList('tipsList', recipe.tips || []);
  
  new bootstrap.Modal(document.getElementById('addRecipeModal')).show();
}

document.querySelector('[data-bs-target="#addRecipeModal"]').addEventListener('click', () => {
  document.getElementById('recipeModalTitle').innerHTML = '<i class="bi bi-plus-circle"></i> Add Recipe';
  document.getElementById('saveBtnText').textContent = 'Save Recipe';
  document.getElementById('deleteRecipeBtn').style.display = 'none';
  document.getElementById('editingRecipeKey').value = '';
  document.getElementById('newKey').disabled = false;
  document.getElementById('addRecipeForm').reset();
  document.getElementById('recipeImageData').value = '';
  
  // Clear image
  const preview = document.getElementById('imagePreview');
  const prompt = document.getElementById('imageUploadPrompt');
  const uploadArea = document.getElementById('imageUploadArea');
  const actions = document.getElementById('imageActions');
  preview.src = '';
  preview.style.display = 'none';
  prompt.style.display = 'block';
  uploadArea.classList.remove('has-image');
  actions.style.display = 'none';
  
  // Clear lists
  document.getElementById('ingredientsList').innerHTML = '';
  document.getElementById('stepsList').innerHTML = '';
  document.getElementById('tipsList').innerHTML = '';
  
  trackEvent('Recipe', 'add_new_clicked', 'toolbar');
});

document.getElementById('saveRecipeBtn').addEventListener('click', () => {
  const editingKey = document.getElementById('editingRecipeKey').value;
  const key = document.getElementById('newKey').value.trim();
  const title = document.getElementById('newTitle').value.trim();
  const imageData = document.getElementById('recipeImageData').value;
  
  // NEW: Get values from draggable lists
  const ing = getDraggableListValues('ingredientsList');
  const steps = getDraggableListValues('stepsList');
  const tips = getDraggableListValues('tipsList');

  if (!key || !title || !ing.length || !steps.length) {
    showToast('Fill all required fields!', 'error');
    trackEvent('Error', 'save_recipe_validation', 'missing_fields');
    return;
  }
  if (!editingKey && key in recipes && !confirm('Overwrite existing recipe?')) return;

  recipes[key] = {
    title,
    icon: recipes[key]?.icon || recipeIcons.default,
    image: imageData || undefined, // NEW: Save image
    ingredients: ing,
    steps,
    tips
  };

  saveRecipes();
  buildPalette();
  buildCalendar(); // Rebuild calendar to show new images
  bootstrap.Modal.getInstance(document.getElementById('addRecipeModal')).hide();
  showToast(`Recipe ${editingKey ? 'updated' : 'added'}!`, 'success');
  trackEvent('Recipe', editingKey ? 'update' : 'create', key);
});

document.getElementById('deleteRecipeBtn').addEventListener('click', () => {
  const key = document.getElementById('editingRecipeKey').value;
  if (!key || !confirm(`Delete "${key}"?`)) return;
  delete recipes[key];
  saveRecipes();
  Object.keys(assignments).forEach(date => {
    if (assignments[date] === key) delete assignments[date];
  });
  saveAssignments();
  buildPalette();
  buildCalendar();
  bootstrap.Modal.getInstance(document.getElementById('addRecipeModal')).hide();
  showToast('Recipe deleted', 'info');
  trackEvent('Recipe', 'delete', key);
});

document.getElementById('downloadHtmlBtn').addEventListener('click', () => {
  activeToasts.forEach(toast => {
    if (toast._dismissTimer) clearTimeout(toast._dismissTimer);
    toast.remove();
  });
  activeToasts.clear();

  const clone = document.cloneNode(true);
  const cloneHtml = clone.documentElement;

  const scriptTags = cloneHtml.querySelectorAll('script');
  scriptTags.forEach(script => {
    if (script.textContent.includes('let recipes =')) {
      let scriptContent = script.textContent;
      scriptContent = scriptContent.replace(
        /let recipes = \{[\s\S]*?\n\};/,
        `let recipes = ${JSON.stringify(recipes, null, 2)};`
      );
      scriptContent = scriptContent.replace(
        /let assignments = \{[^}]*\};/,
        `let assignments = ${JSON.stringify(assignments, null, 2)};`
      );
      script.textContent = scriptContent;
    }
  });

  let html = '<!DOCTYPE html>\n' + cloneHtml.outerHTML;

  const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `meal-planner-${new Date().toISOString().split('T')[0]}.html`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  showToast('Meal plan saved successfully!', 'success');
  trackEvent('Data', 'download_html', 'save_button');
});

document.getElementById('clearAllBtn').addEventListener('click', () => {
  if (!confirm('Clear all assignments?')) return;
  const count = Object.keys(assignments).length;
  assignments = {};
  saveAssignments();
  buildCalendar();
  recipeDetails.innerHTML = '<div class="empty-state"><i class="bi bi-cursor"></i><p>Assign meals to get started</p></div>';
  showToast('Calendar cleared', 'info');
  trackEvent('Data', 'clear_all', count);
});

document.getElementById('printBtn').addEventListener('click', () => {
  window.print();
  trackEvent('UI', 'print', 'button');
});

window.addEventListener('resize', () => {
  const was = isMobile;
  isMobile = detectMobile();
  if (was !== isMobile) {
    buildPalette();
    buildCalendar();
    trackEvent('UI', 'resize', isMobile ? 'mobile' : 'desktop');
  }
});

window.addEventListener('beforeunload', () => {
  activeToasts.forEach(toast => {
    if (toast._dismissTimer) clearTimeout(toast._dismissTimer);
  });
});

// Initialize everything
loadData();
setupImageUpload();
setupDraggableLists();
buildPalette();
buildCalendar();
console.log('üçΩÔ∏è Meal Planner Pro v4 ready!');
trackEvent('App', 'loaded', 'v4');
</script>



</body></html>
